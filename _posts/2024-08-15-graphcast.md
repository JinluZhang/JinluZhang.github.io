---
layout: post
title: 'GraphCast/GenCast学习笔记'
date: 2024-08-15
categories: 预测
author: Beaug
tags: 预测 GNN
---

预测相关论文看了不少，但这两篇总能时不时想起来，休假在家想写点啥，就把阅读论文和源码的相关笔记整理了下。

# 一些HighLight

```
DeepMind总是能发现一些问题领域，适合用机器学习方法重新解一遍题，蛋白质预测、可控核聚变、天气预报，都是。这些场景具备如下特质：1）有充分的历史数据，可以用于模型training；2）问题本身是有规律的，只是这个规律或用数学公式计算困难，或还没有被充分发现（自然科学领域大多具备这一特征）；3）当前还没有做的足够好（这个判断并不容易）

GraphCast的图结构设计很有意思，点和边是两套东西。点是0.25°经纬度的正方形共721×1440=1,038,240个。但点之间的连接关系并不是按相邻关系定义的，而是构建了multi-mesh，通过把地球表面划分成二十面体，然后再做每个面的三角形一拆四，这样细拆下去6层，共拆出40,962个multi-mesh节点。具有属性的node直接的连接关系，是通过和multi-mesh节点做映射得到的。

GraphCast中对GNN有一段很有意思的洞见：


```





# GraphCast

## 1.简介

2022年10月中旬，意大利博洛尼亚，欧洲中期天气预报中心（ECMWF）新建的高性能计算设施正式投入使用，时间是世界协调时间（UTC）05:45。过去几个小时，综合预报系统（IFS）一直在进行复杂的计算，以预测地球未来几天和几周的天气，而它的首次预测刚刚开始向用户发布。这个过程每六小时重复一次，每天进行，以向世界提供最准确的天气预报。

IFS和现代天气预报更广义上的成功，代表了科学和工程的胜利。天气系统的动力学是地球上最复杂的物理现象之一，每天，无数个人、行业和政策制定者的决策依赖于准确的天气预报，从决定是否穿夹克到是否逃避危险的风暴。今天天气预报的主流方法是“数值天气预报”（NWP），它通过超级计算机求解天气的控制方程。NWP的成功源于严格且持续的研究实践，这些实践提供了对天气现象越来越详细的描述，以及NWP如何随着计算资源的增加而精度提升。因此，天气预报的准确性年复一年地提高，甚至可以预测飓风的路径，提前很多天进行预报——这是几十年前根本无法想象的可能性。

然而，尽管传统的NWP在计算上扩展性良好，但利用大量历史天气数据来提高准确性并非易事。NWP方法的改进依赖于经过高度训练的专家，通过创新更好的模型、算法和近似方法，这一过程既耗时又昂贵。

基于机器学习的天气预测（MLWP）为传统的NWP提供了一种替代方案，其中预报模型可以通过历史数据（包括观测和分析数据）进行训练。这有望通过捕捉数据中的模式来提高预测准确性，这些模式在显式方程中不容易表示。MLWP还提供了通过利用现代深度学习硬件而非超级计算机，从而实现更高效率的机会，并能够在速度与精度之间找到更有利的折中。最近，MLWP在传统NWP相对薄弱的领域取得了进展，例如亚季节性的热浪预测和雷达图像降水即时报，这些领域中准确的方程和稳健的数值方法并不容易得到。

在中期天气预报中，即预测最多10天的气象变量，基于NWP的系统，如IFS，仍然是最准确的。世界上最顶尖的确定性操作系统是ECMWF的高分辨率预报（HRES），这是IFS的一种配置，可以在大约一个小时内生成全球10天的预报，分辨率为0.1°经纬度。然而，近年来，基于重分析数据训练的MLWP方法在中期预报中的发展稳步推进，借助WeatherBench等基准测试。基于卷积神经网络和变换器的深度学习架构在分辨率大于1.0°的经纬度范围内取得了有希望的结果，最近的一些研究——使用图神经网络（GNN）、傅里叶神经算子和变换器——报告称，它们的表现开始与IFS在1.0°和0.25°分辨率下的预测相媲美，适用于一些变量，且预报的领先时长可达到7天。

## 2.GraphCast模型结构概述

在此，我们介绍了一种用于全球中期天气预报的机器学习天气预测（MLWP）方法，称为“GraphCast”。它能够在单个 Google Cloud TPUv4设备上，在不到一分钟的时间内生成准确的10天天气预报，并支持多种应用场景，包括预测热带气旋路径、大气河流以及极端温度。

==GraphCast 的输入为地球天气的最近两次状态（当前时间和6小时前），并预测6小时后的下一次天气状态。== 单个天气状态用一个0.25°经纬度网格（721 × 1440）表示约相当于赤道上28×28公里的分辨率(Fig. 1a)，每个网格点表示一组地表和大气变量（列于表1中）。与传统的数值天气预报（NWP）系统类似，GraphCast是自回归的：可以通过将其自身的预测作为输入进行“滚动”预测，从而生成任意长度的天气状态序列。

<span style="color:red">为啥不用更长时间的数据，是因为通过网络传导，更之前是数据信息，已经充分包含在t-1/t-2两个时间片里面了？</span>

GraphCast 的实现基于一种神经网络架构，采用图神经网络（GNN）的“编码-处理-解码”配置，总共包含3670万个参数。==之前基于GNN的学习模拟器在学习由偏微分方程建模的流体和其他系统的复杂动力学方面非常有效，证明了它们适合建模天气动力学。==

编码器 (Fig. 1d) ：使用单层GNN将正方形node上的5+6×37个变量（经过了零均值和单位方差归一化）映射为内部“multi-mesh”上的节点的属性。

multi-mesh (Fig. 1g) ：是一个空间均匀的图，具有高空间分辨率。它通过对规则的二十面体（12个节点、20个面、30条边）进行六次迭代细分生成，每次细分将每个三角形划分为四个更小的三角形（导致面和边的数量增加四倍），并将节点重新投影到球面上。最终multi-mesh包含来自最高分辨率网格的40,962个节点（约为0.25°经纬度网格点数量的1/25），以及中间图中所有边的集合，形成了一个具有不同长度的边的平坦层级结构。<span style="color:red">每个层级上，点都具有5条边，对于第一层的12个节点，它具有6x5=30条边，第二层多出来的节点，具有5x5=25条边，以此类推</span>

处理器 (Fig. 1e) ：使用16层不共享的GNN层，在多网格上执行学习的消息传递，实现了通过较少的消息传递步骤高效传播局部和远程信息。

解码器 (Fig. 1f) ：将处理器最后一层的学习特征从多网格表示映射回经纬度网格。它使用单层GNN，并预测输出作为对最近输入状态的残差更新（通过输出归一化实现目标残差的单位方差）。详细的架构信息见补充材料第3节。

在模型开发过程中，我们使用了来自ECMWF的ERA5重分析档案的39年历史数据（1979-2017）。训练目标是平均GraphCast预测状态在N个自回归步骤上的均方误差（MSE）与对应的ERA5状态之间的误差，并根据垂直层级加权。在训练过程中，N的值逐步从1增加到12（即从6小时到3天），通过时间反向传播计算损失的梯度（22）。GraphCast 使用梯度下降进行训练，总共耗时约四周，在32个Cloud TPU v4设备上进行批量并行。

GraphCast模型每个点上的变量值，一共是5项Surface variables、6项Atmospheric variables分别在37个Pressure levels上的值。5 + 6 × 37 = 227 variables per point in total。具体内容为：

- 地表变量（5项）：2米温度 (2T)、10米U风分量 (10U)、10米V风分量 (10V)、海平面气压 (MSL)、总降水量 (TP)

- 大气变量（6项）：温度 (T)、风的U分量 (U)、风的V分量 (V)、位势高度 (Z)、比湿 (Q)、垂直风速 (W)

- 压力水平（37项）：1, 2, 3, 5, 7, 10, 20, 30, 50, 70, 100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1000.


## 3.Notation and problem statement

### 3.1 时间符号

在天气预报中使用的时间符号可能会引起混淆，涉及多个不同的时间符号，例如用于表示初始预报时间、有效时间、预报时效等。因此，为了清晰和简便，我们引入了一些标准化的术语和符号。我们将某个特定时间点称为“日期-时间”，并用日历日期和UTC时间表示。例如，2018-06-21_18:00:00表示2018年6月21日，18:00 UTC。 为了简便起见，我们有时也使用Zulu时间约定，即00z、06z、12z、18z分别表示00:00、06:00、12:00、18:00 UTC。我们进一步定义了以下符号：

t：预报时间步索引，表示自预报初始化以来的步数。

T：预报时效，表示预报的总步数。

d：有效时间，表示特定天气状态的日期-时间。

d0：预报初始化时间，表示预报初始输入的有效时间。

∆d：预报步长，表示每一步预报的时间间隔。

τ：预报提前时间，表示预报中的经过时间（即τ = t∆d）。

### 3.2.一般的预报问题陈述

令$Z^d$表示在时间$d$时全球天气的真实状态。真实天气的时间演化可以通过一个基本的离散时间动力学函数 Φ 来表示，该函数基于当前状态生成下一个时间步的状态（未来 ∆d 时间步），即：$Z^(d+∆d)=Φ(Z^d)$。
然后，我们通过自回归地应用 Φ T 次，获得 T 个未来的天气状态：

$$
Z^{d+\Delta d : d+T \Delta d} = \left( \Phi \left( Z^d \right), \Phi \left( Z^{d+\Delta d} \right), \dots, \Phi \left( Z^{d+(T-1)\Delta d} \right) \right)
$$


我们的目标是找到一个准确且高效的模型 φ，来逼近真实的动力学函数 Φ，并能高效地预测未来一段时间内的天气状态，时效为 T ∆d。我们假设不能直接观察 Zd，而只能得到某些部分观测值 Xd，它是不完全的状态信息表示，不能完美地预测天气。由于 Xd 只是瞬时状态 Zd 的近似值，我们还会向模型提供一个或多个过去的状态 Xd−∆d、Xd−2∆d 等，除了 Xd 外。这使得模型能够利用额外的上下文信息，从而更准确地逼近 Zd。因此，模型 φ 预测未来天气状态为：

$$
\hat{X}^{d+\Delta d : d+T \Delta d} = \left( \phi \left( X^d, X^{d-\Delta d}, \dots \right), \phi \left( \hat{X}^{d+\Delta d}, X^d, \dots \right), \dots, \phi \left( \hat{X}^{d+(T-1) \Delta d}, \hat{X}^{d+(T-2) \Delta d}, \dots \right) \right)
$$

类似于方程（1），预测 Xˆd+∆d 可以反馈到 φ 中，以自回归的方式生成完整的预报：
Xˆd+∆d:d+T∆d = (φ(Xd, Xd−∆d, ...), φ(Xˆd+∆d, Xd, ...), ..., φ(Xˆd+(T−1)∆d, Xˆd+(T−2)∆d, ...))。（3）
我们通过量化预测轨迹 Xˆd+∆d:d+T∆d 与真实轨迹 Xd+∆d:d+T∆d 的匹配程度来评估模型 φ 的预报质量或技能。然而，需要再次强调的是，Xˆd+∆d:d+T∆d 仅包含我们对 Zd+∆d:d+T∆d 的观测，而 Zd+∆d:d+T∆d 本身是不可观测的。我们通过以下目标函数来衡量预报与真实值之间的一致性：
L(Xˆd+∆d:d+T∆d, Xd+∆d:d+T∆d)，
该函数在第5节中会明确描述。

在我们的工作中，数据和预报的时间分辨率始终为 ∆d = 6小时，最大预报时效为10天，对应总步数 T = 40。由于 ∆d 在本文中始终是常数，我们可以简化符号，使用 (Xt, Xt+1, ..., Xt+T) 来代替 (Xd, Xd+∆d, ..., Xd+T∆d)，即用整数索引时间而不是特定的日期时间。








# 参考文献
一个team member的分享 https://www.youtube.com/watch?v=PD1v5PCJs_o
 [GraphCast](https://www.science.org/doi/10.1126/science.adi2336)
 [GenCast](https://arxiv.org/abs/2312.15796)


